# main.py
from flask import Flask, render_template, request, session, redirect, url_for
import random
import json

app = Flask(__name__)
app.secret_key = 'your_very_secret_key_123'  # 必须设置密钥

# ----------------- 塔罗牌数据定义 -----------------
MAJOR_ARCANA = [
    '愚人', '魔术师', '女祭司', '女皇', '皇帝', '教皇', '恋人', '战车',
    '力量', '隐士', '命运之轮', '正义', '倒吊人', '死神', '节制', '恶魔',
    '塔', '星星', '月亮', '太阳', '审判', '世界'
]

SUITS = ['权杖', '圣杯', '宝剑', '星币']
RANKS = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '侍者', '骑士', '皇后', '国王']
MINOR_ARCANA = [f'{suit}{rank}' for suit in SUITS for rank in RANKS]

TAROT_CARDS = MAJOR_ARCANA + MINOR_ARCANA

# 简化的牌义（实际使用中建议扩充）
CARD_MEANINGS = {
    '愚人': ('新的恋情开始，心态开放，可能遇到命中注定的人。', '感情中缺乏责任感或盲目投入，易陷入不稳定关系。'),
    '魔术师': ('有魅力的恋爱开端，主动追求成功。', '关系中可能存在欺骗或虚伪。'),
    '女祭司': ('暗恋或情感尚未公开，深沉而神秘。', '隐瞒或情绪压抑，沟通受阻。'),
    '女皇': ('充满爱与包容的恋情，可能象征家庭或怀孕。', '关系中可能过于依赖或溺爱。'),
    '皇帝': ('伴侣可靠，恋情趋于稳定成熟。', '控制欲强，缺乏情感交流。'),
    '教皇': ('传统稳重的关系，得到长辈认可。', '不被认同的恋情，价值观冲突。'),
    '恋人': ('真爱出现，选择明确，命运安排。', '三角恋、犹豫不决，可能错失良缘。'),
    '战车': ('积极追爱，快速发展，勇敢有成果。', '推进过快导致关系失控。'),
    '力量': ('温柔坚定的爱，包容对方缺点。', '压抑感情，关系中软弱或冷战。'),
    '隐士': ('暂时单身，专注内在探索。', '过度封闭，难以接受感情。'),
    '命运之轮': ('命运的转折，缘分自然而至。', '不稳定的恋情，无法掌控的局面。'),
    '正义': ('公正平衡的爱情关系，彼此相互尊重。', '恋情中的不公正，可能有偏见或误解。'),
    '倒吊人': ('改变视角，爱情中的牺牲与等待。', '在感情中感到困顿或自我牺牲过度。'),
    '死神': ('结束与新生，可能是感情中的转折点。', '感情的死结，或关系中的无望。'),
    '节制': ('和谐与平衡的爱情关系，双方包容。', '缺乏平衡，爱情中可能出现过度依赖。'),
    '恶魔': ('强烈的欲望与诱惑，可能是深深的迷恋。', '感情中的束缚或不健康的依赖。'),
    '塔': ('剧烈的变化，可能是一段感情的崩溃或重生。', '感情中的剧变或失控，可能带来意外的痛苦。'),
    '星星': ('希望与启示，感情中充满希望和可能性。', '迷茫或失去方向，感情中的不确定性。'),
    '月亮': ('感情中的浪漫与神秘，可能存在虚幻。', '误解或幻象，爱情中的不稳定与不安。'),
    '太阳': ('充满快乐与满足的爱情，阳光明媚。', '缺乏真正的联系，可能表面光鲜但空虚。'),
    '审判': ('爱情的觉醒或复苏，可能是重新开始。', '情感中的误解或被压抑的感情需要面对。'),
    '世界': ('圆满的爱情，目标的实现，圆满的关系。', '感情中的停滞，缺乏进展或完成感。'),
    # 小阿尔卡那默认值，为防止报错，此处省略具体定义，实际代码中请保留原有的完整字典
    # ... (保留你原有的完整 CARD_MEANINGS 字典) ...
}

# 补充缺失的小阿尔卡那默认含义（防止KeyError，实际请使用你原来的完整数据）
for card in MINOR_ARCANA:
    if card not in CARD_MEANINGS:
        CARD_MEANINGS[card] = ('正位含义：能量顺畅，积极发展。', '逆位含义：能量受阻，需要反思。')


# ----------------- 牌阵定义 (包含图片识别出的所有牌阵) -----------------
SPREADS = {
    "三牌时间流": ["过去的情感影响", "现在的感情状态", "未来的发展趋势"],
    "爱情十字": ["你的现状", "对方的心意", "关系阻碍", "潜在助力", "最终结果"],
    "心灵感应阵": ["你的表层想法", "你的深层渴望", "对方的表层想法", "对方的深层感受", "双方的默契程度", "未说出口的真相", "关系发展建议"],
    "复合可能性": ["分手根本原因", "你的真实想法", "对方的实际态度", "当前阻碍因素", "潜在转机点", "复合成功率"],
    "婚姻前景阵": ["感情基础", "现实考验", "需要克服的困难", "婚姻可能性"],
    "双向视角阵": ["你眼中的自己", "你眼中的对方", "对方眼中的自己", "对方眼中的你", "关系中的平衡点", "需要调整的差异"],
    "七日爱情阵": ["周一：情感状态", "周二：沟通重点", "周三：潜在危机", "周四：意外惊喜", "周五：行动建议", "周六：约会指引", "周日：总结启示"],
    "障碍诊断阵": ["核心问题", "表面现象", "深层原因", "解决方法", "最终结果"],
    "灵魂伴侣阵": ["前世连接", "今生使命", "吸引力来源", "需要学习的课题", "潜在冲突点", "灵性成长方向", "物质层面适配", "精神层面共鸣", "最终发展走向"],
    "新恋情预测": ["你的准备状态", "将遇见的类型", "出现时间提示", "发展注意事项"],
    "灵感对应牌阵": ["对方在你心里的位置", "他对你心里的位置", "我对现在关系的看法", "对方对现在关系的看法", "我对未来发展的期待", "对方对未来发展的期待"],
    "吉普赛十字牌阵": ["你的现状", "对方的心意", "当下相处模式", "外界影响", "发展结果"],
    "暗恋牌阵": ["对方是否喜欢你", "是否采取行动", "能否在一起", "对方是否喜欢的人", "建议"],
    "视奸前任牌阵": ["对方当前感情状况", "对方目前财务状况", "对方目前对你的看法", "离开之后对方有没有想起过你", "对方后悔和你分开吗"],
    "心之声牌阵": ["你们的现状", "不久的未来", "对你的内在印象", "对你的外在印象", "对方心态", "对方期待", "你的心态", "建议"],
    "未来恋人牌阵": ["对方是什么样的人", "出现了吗", "近期对方有什么暗示", "如何吸引对方", "和对方在一起有什么挑战", "在一起的收获", "你们未来发展趋势"],
    "X牌阵 复合首选": ["你们的过去", "你的现状", "对方现状", "他对复合的想法", "结果", "阻碍你的", "帮助你的", "不知道的事"],
    "二选一牌阵": ["你当下状态", "选A后的状况", "选A的结果", "选B面临的状况", "选B的结果"],
    "三角关系牌阵": ["对方现状", "你的现状", "第三方现状", "你们之间的关系", "第三方对你们的影响", "对方和第三方之间的关系"],
    "恋人金字塔牌阵": ["问卜者自己", "问卜者对象", "彼此的关系", "未来发展的走向"],
    "爱情三角牌阵": ["问卜者自己", "问卜者对象", "彼此的关系/潜力"],
    "恋人回归牌阵": ["前任对我的看法", "前任对复合的看法", "复合的阻碍", "两人关系的未来"],
    "爱情十字牌阵": ["问卜者自己的态度", "对方的态度", "现阶段状况", "未来发展", "结果"],
    "爱情关系牌阵": ["问卜者自己", "对方", "自己在这段感情中的位置", "如何一起成长", "自己渴望的成长", "建议"],
    "维纳斯之爱牌阵": ["问卜者心态", "对方心态", "对对方的真实想法", "对方对问卜者的真实想法", "阻碍", "未来自己的心态", "未来对方的心态", "想像的结果"]
}

# ----------------- 牌阵简介 (用于前端悬停显示) -----------------
SPREAD_DESCRIPTIONS = {
    "三牌时间流": "经典牌阵。快速查看事情的过去根源、现在状况和未来自然走向。",
    "爱情十字": "全方位分析。涵盖你的现状、对方真实心意、当前阻碍及最终结果。",
    "心灵感应阵": "潜意识深挖。对方在想什么？你们之间未说出口的真相是什么？",
    "复合可能性": "分手专用。分析分手根源、双方真实意愿、阻碍及复合成功率。",
    "婚姻前景阵": "备婚/长期关系。分析感情基础、现实考验与婚姻匹配度。",
    "双向视角阵": "换位思考。看清你在对方眼里的样子，以及认知差异。",
    "七日爱情阵": "运势预测。未来一周每一天的感情重点与行动建议。",
    "障碍诊断阵": "问题解决。事情卡住了？深度挖掘核心问题与深层原因。",
    "灵魂伴侣阵": "灵性分析。看你们是否是命中注定的灵魂伴侣，前世今生的连接。",
    "新恋情预测": "单身必测。下一任是新人还是旧人？特征是什么？何时出现？",
    "灵感对应牌阵": "心意互通。深度对谈双方内心真实想法与对未来的期待。",
    "吉普赛十字牌阵": "古老预测。预测短期内的运势、对方心意及外界影响。",
    "暗恋牌阵": "暧昧/暗恋。对方喜欢我吗？我该行动吗？会有结果吗？",
    "视奸前任牌阵": "窥探前任。分手后他过得好吗？有没有想你？后悔了吗？",
    "心之声牌阵": "内心共鸣。倾听彼此内心的声音，分析现状、心态与期待。",
    "未来恋人牌阵": "描绘画像。未来伴侣是什么样的人？如何吸引TA？",
    "X牌阵 复合首选": "深度复合分析。双方现状、阻碍、潜意识想法及未知因素。",
    "二选一牌阵": "决策辅助。面临两个选择（如选A人还是B人，行动还是等待）？分析各自结果。",
    "三角关系牌阵": "复杂关系。分析你、对方及第三者之间的角力与最终走向。",
    "恋人金字塔牌阵": "简洁明了。分析你们的关系结构、各自立场与未来。",
    "爱情三角牌阵": "理论分析。基于斯腾伯格爱情三元论（激情、亲密、承诺）分析潜力。",
    "恋人回归牌阵": "挽回分析。专注于前任是否会回头，以及复合的阻碍。",
    "爱情十字牌阵": "经典变体。分析双方态度、现状及最终结果。",
    "爱情关系牌阵": "共同成长。如何在关系中找到平衡？寻找双方的成长点。",
    "维纳斯之爱牌阵": "深度剖析。全方位无死角的情感分析，适合复杂情感问题。"
}

# ----------------- 路由逻辑 -----------------

@app.route('/')
def index():
    # 将描述信息传递给前端
    return render_template('index.html', spreads=SPREADS, descriptions=SPREAD_DESCRIPTIONS)

@app.route('/select')
def select():
    spread_name = request.args.get('spread')
    question = request.args.get('question')
    if not spread_name or spread_name not in SPREADS:
        return redirect(url_for('index'))

    # 生成预洗牌的牌组（包含正逆位）
    deck = [{
        'card': card,
        'orientation': random.choice(["正位", "逆位"])
    } for card in TAROT_CARDS]
    random.shuffle(deck)

    deck_info = json.dumps({
        str(i): {"card": card['card'], "orientation": card['orientation']}
        for i, card in enumerate(deck)
    }, ensure_ascii=False)

    session['deck'] = deck
    session['deck_info'] = deck_info
    session['spread_name'] = spread_name
    session['num_cards'] = len(SPREADS[spread_name])
    session['question'] = question

    return render_template('select.html',
                           num_cards=session['num_cards'],
                           spread_name=spread_name,
                           deck_info=deck_info)

@app.route('/draw', methods=['POST'])
def draw():
    try:
        selected_indices = json.loads(request.form['selected_indices'])
        spread_name = request.form['spread']
        question = session.get('question', '')

        deck = session.get('deck', [])
        spread_name_session = session.get('spread_name')
        num_cards_session = session.get('num_cards')

        if (not deck or spread_name != spread_name_session or len(selected_indices) != num_cards_session):
            return redirect(url_for('index'))

        result = []
        for idx in selected_indices:
            if 0 <= idx < len(deck):
                card_info = deck[idx]
                # 获取牌义，如果字典里没有则使用默认
                meanings = CARD_MEANINGS.get(card_info['card'], ('正位默认含义', '逆位默认含义'))
                meaning = meanings[0 if card_info['orientation'] == '正位' else 1]
                
                result.append({
                    "card": card_info['card'],
                    "orientation": card_info['orientation'],
                    "meaning": meaning
                })

        positions = SPREADS.get(spread_name, [])

        return render_template('result.html',
                               question=question,
                               cards=result,
                               positions=positions,
                               spread_name=spread_name)
    except Exception as e:
        print(f"Error: {str(e)}")
        return redirect(url_for('index'))

if __name__ == '__main__':
    app.run(debug=True, port=5002)