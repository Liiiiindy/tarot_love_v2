# main.py
from flask import Flask, render_template, request, session, redirect, url_for
import random
import json

app = Flask(__name__)
app.secret_key = 'your_very_secret_key_123'  # 必须设置密钥

# ----------------- 塔罗牌数据定义 -----------------
MAJOR_ARCANA = [
    '愚人', '魔术师', '女祭司', '女皇', '皇帝', '教皇', '恋人', '战车',
    '力量', '隐士', '命运之轮', '正义', '倒吊人', '死神', '节制', '恶魔',
    '塔', '星星', '月亮', '太阳', '审判', '世界'
]

SUITS = ['权杖', '圣杯', '宝剑', '星币']
RANKS = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '侍者', '骑士', '皇后', '国王']
MINOR_ARCANA = [f'{suit}{rank}' for suit in SUITS for rank in RANKS]

TAROT_CARDS = MAJOR_ARCANA + MINOR_ARCANA

CARD_MEANINGS = {
    '愚人': ('新的恋情开始，心态开放，可能遇到命中注定的人。', '感情中缺乏责任感或盲目投入，易陷入不稳定关系。'),
    '魔术师': ('有魅力的恋爱开端，主动追求成功。', '关系中可能存在欺骗或虚伪。'),
    '女祭司': ('暗恋或情感尚未公开，深沉而神秘。', '隐瞒或情绪压抑，沟通受阻。'),
    '女皇': ('充满爱与包容的恋情，可能象征家庭或怀孕。', '关系中可能过于依赖或溺爱。'),
    '皇帝': ('伴侣可靠，恋情趋于稳定成熟。', '控制欲强，缺乏情感交流。'),
    '教皇': ('传统稳重的关系，得到长辈认可。', '不被认同的恋情，价值观冲突。'),
    '恋人': ('真爱出现，选择明确，命运安排。', '三角恋、犹豫不决，可能错失良缘。'),
    '战车': ('积极追爱，快速发展，勇敢有成果。', '推进过快导致关系失控。'),
    '力量': ('温柔坚定的爱，包容对方缺点。', '压抑感情，关系中软弱或冷战。'),
    '隐士': ('暂时单身，专注内在探索。', '过度封闭，难以接受感情。'),
    '命运之轮': ('命运的转折，缘分自然而至。', '不稳定的恋情，无法掌控的局面。'),
    '正义': ('公正平衡的爱情关系，彼此相互尊重。', '恋情中的不公正，可能有偏见或误解。'),
    '倒吊人': ('改变视角，爱情中的牺牲与等待。', '在感情中感到困顿或自我牺牲过度。'),
    '死神': ('结束与新生，可能是感情中的转折点。', '感情的死结，或关系中的无望。'),
    '节制': ('和谐与平衡的爱情关系，双方包容。', '缺乏平衡，爱情中可能出现过度依赖。'),
    '恶魔': ('强烈的欲望与诱惑，可能是深深的迷恋。', '感情中的束缚或不健康的依赖。'),
    '塔': ('剧烈的变化，可能是一段感情的崩溃或重生。', '感情中的剧变或失控，可能带来意外的痛苦。'),
    '星星': ('希望与启示，感情中充满希望和可能性。', '迷茫或失去方向，感情中的不确定性。'),
    '月亮': ('感情中的浪漫与神秘，可能存在虚幻。', '误解或幻象，爱情中的不稳定与不安。'),
    '太阳': ('充满快乐与满足的爱情，阳光明媚。', '缺乏真正的联系，可能表面光鲜但空虚。'),
    '审判': ('爱情的觉醒或复苏，可能是重新开始。', '情感中的误解或被压抑的感情需要面对。'),
    '世界': ('圆满的爱情，目标的实现，圆满的关系。', '感情中的停滞，缺乏进展或完成感。'),

    # 小阿尔卡那（权杖，圣杯，宝剑，星币）
    '权杖一': ('新的恋爱机会，充满激情的开始。', '冲动的爱情选择，可能导致过快的失望。'),
    '权杖二': ('展现领导力，建立更成熟的感情关系。', '过度关注自我，忽略感情中的妥协。'),
    '权杖三': ('积极的沟通，愿意为爱情付出。', '关系中的不信任，沟通缺乏效果。'),
    '权杖四': ('稳定的爱情，幸福的家庭生活。', '关系中的稳定性差，可能存在隐患。'),
    '权杖五': ('爱情中的争斗与竞争，感情中有摩擦。', '争执过多，可能导致感情中的隔阂。'),
    '权杖六': ('爱情中的胜利与认可，伴侣支持。', '过度依赖伴侣或缺乏自我成就。'),
    '权杖七': ('坚守爱情中的立场，勇敢捍卫感情。', '爱情中无法达成共识，缺乏沟通。'),
    '权杖八': ('爱情的快速发展与改变，充满活力。', '爱情进展过快，可能导致矛盾升级。'),
    '权杖九': ('守护爱情的努力与坚持，展现信念。', '感情中的疲惫与过度防守，难以放松。'),
    '权杖十': ('沉重的责任与义务，感情中的压力。', '负担沉重，可能在关系中感到无法承受的压力。'),
    '权杖侍者': ('充满好奇心与冒险精神，愿意尝试新的感情体验。', '情感中的不成熟，可能感到不确定或冲动。'),
    '权杖骑士': ('快速而热烈的爱情，充满激情的追求。', '冲动的爱情行动，可能导致伤害。'),
    '权杖皇后': ('自信独立，充满热情的爱情。', '过度控制或缺乏包容心。'),
    '权杖国王': ('成熟稳重的爱情，领导力与责任感。', '过于专制或情感冷漠，缺乏亲密感。'),

    # 圣杯（感情与情感）
    '圣杯一': ('新的爱情开始，感情的纯洁与真诚。', '感情中可能存在虚假或不成熟的情感表现。'),
    '圣杯二': ('爱情中的和谐与共鸣，双方相互吸引。', '关系中的失衡或相互依赖过强。'),
    '圣杯三': ('庆祝爱情的喜悦，朋友与伴侣之间的和谐。', '可能陷入社交压力中，忽视爱情的真实需求。'),
    '圣杯四': ('情感的沉思，反思爱情的真谛。', '对感情失去兴趣或感觉情感的空虚。'),
    '圣杯五': ('情感的失落与悲伤，面对爱情的失望。', '过于沉溺过去的痛苦，无法放下。'),
    '圣杯六': ('温馨的回忆，可能是童年或初恋的情感。', '沉溺于过去的情感中，无法走出过去的阴影。'),
    '圣杯七': ('情感的选择与幻想，爱情中的选择多样。', '无法作出决定，感情中迷茫和幻想。'),
    '圣杯八': ('离开旧爱，寻找新方向。', '过于急于离开，逃避感情中的问题。'),
    '圣杯九': ('感情中的满足与喜悦，爱情的圆满。', '表面上的幸福，实际缺乏深入的连接。'),
    '圣杯十': ('完美的爱情与家庭，幸福的象征。', '过度依赖家庭或爱情，缺乏独立性。'),
    '圣杯侍者': ('对爱情充满好奇，渴望探索情感世界。', '情感的不成熟或情绪的波动性大。'),
    '圣杯骑士': ('浪漫与追求，渴望表达感情。', '过于理想化爱情，可能产生失望。'),
    '圣杯皇后': ('包容与同情的爱情，富有母性光辉。', '过度的依赖或情感上的溺爱。'),
    '圣杯国王': ('成熟稳定的感情关系，深具魅力与理解力。', '情感上过于冷静或无法表达内心的情感。'),

    # 宝剑（思想与沟通）
    '宝剑一': ('清晰的思维，爱情中的理性选择。', '感情中缺乏沟通或误解，无法清晰表达。'),
    '宝剑二': ('爱情中的平衡与选择，需要做出艰难的决策。', '情感的阻碍或犹豫不决，难以做出决定。'),
    '宝剑三': ('感情中的痛苦与分离，爱情中的伤害。', '情感上的冷漠与孤独，可能由于过度的伤害。'),
    '宝剑四': ('休息与恢复，情感的恢复期。', '感情中的疲惫，可能需要时间来修复关系。'),
    '宝剑五': ('争斗与冲突，感情中的误解与斗争。', '伤害他人的行为，关系中的不公。'),
    '宝剑六': ('感情中的旅程，离开过去，走向新的方向。', '无法放下过去，情感中的解脱受阻。'),
    '宝剑七': ('爱情中的隐秘与狡猾，可能存在不诚实。', '感情中的背叛与欺骗，缺乏信任。'),
    '宝剑八': ('感情中的束缚与无助，受到外界压力的影响。', '被困在痛苦中，无法做出改变。'),
    '宝剑九': ('内心的恐惧与焦虑，情感上的忧虑。', '过度的焦虑，感情中可能出现情绪低谷。'),
    '宝剑十': ('感情的彻底破裂，遭遇情感的崩溃。', '悲伤与失望，可能是无法挽回的结局。'),
    '宝剑侍者': ('对爱情保持警觉，时刻准备应对变化。', '情感上的不成熟，冲动和过于理性。'),
    '宝剑骑士': ('快速而有力的爱情行动，追求心中的真爱。', '过于激进的爱情行动，可能带来冲突。'),
    '宝剑皇后': ('理智与情感的平衡，冷静而理性的爱情决策。', '情感上的冷漠与理性思维过强。'),
    '宝剑国王': ('成熟的思维与理性，稳定的情感表达。', '过于理智，情感上缺乏柔软与表达。'),

    # 星币（物质与现实）
    '星币一': ('爱情中的实际行动，稳定的开始。', '过于物质化，忽视情感的细腻。'),
    '星币二': ('爱情中的平衡与选择，注重现实与责任。', '在感情中无法找到平衡，可能过于注重物质。'),
    '星币三': ('合作与建设，感情中共同努力与发展。', '缺乏共同目标或太过于依赖一方。'),
    '星币四': ('爱情中的稳定与持久，彼此重视实际。', '过于固守现状，缺乏创新或发展。'),
    '星币五': ('贫困与缺乏，感情中的困难与挑战。', '感情中的困难或孤立，可能带来不安。'),
    '星币六': ('爱情中的慷慨与分享，关心彼此的物质需求。', '过度依赖对方或感情中的不平衡。'),
    '星币七': ('耐心等待，爱情中的付出与回报。', '等待的过程中缺乏进展，感情中可能不被珍惜。'),
    '星币八': ('爱情中的专注与工作，努力投入情感。', '感情中的单调或过度工作，忽视情感交流。'),
    '星币九': ('爱情中的独立与满足，彼此尊重空间。', '过于自我，忽视对方的需求。'),
    '星币十': ('完美的家庭与事业，爱情的圆满。', '感情中的过度依赖，可能带来不健康的关系。'),
    '星币侍者': ('探索爱情中的稳定与长期目标。', '情感上的过度谨慎，缺乏热情。'),
    '星币骑士': ('稳步追求爱情，踏实且可靠。', '过于保守，感情中缺乏激情。'),
    '星币皇后': ('关怀与富足的爱情，提供温暖与支持。', '过度依赖物质，缺乏情感上的连结。'),
    '星币国王': ('事业与家庭兼顾，爱情中的稳定与责任。', '过度注重物质，忽视情感交流。'),
}


# ----------------- 牌阵定义 (包含图片识别出的所有牌阵) -----------------
SPREADS = {
    "三牌时间流": ["过去的情感影响", "现在的感情状态", "未来的发展趋势"],
    "爱情十字": ["你的现状", "对方的心意", "关系阻碍", "潜在助力", "最终结果"],
    "心灵感应阵": ["你的表层想法", "你的深层渴望", "对方的表层想法", "对方的深层感受", "双方的默契程度", "未说出口的真相", "关系发展建议"],
    "复合可能性": ["分手根本原因", "你的真实想法", "对方的实际态度", "当前阻碍因素", "潜在转机点", "复合成功率"],
    "婚姻前景阵": ["感情基础", "现实考验", "需要克服的困难", "婚姻可能性"],
    "双向视角阵": ["你眼中的自己", "你眼中的对方", "对方眼中的自己", "对方眼中的你", "关系中的平衡点", "需要调整的差异"],
    "七日爱情阵": ["周一：情感状态", "周二：沟通重点", "周三：潜在危机", "周四：意外惊喜", "周五：行动建议", "周六：约会指引", "周日：总结启示"],
    "障碍诊断阵": ["核心问题", "表面现象", "深层原因", "解决方法", "最终结果"],
    "灵魂伴侣阵": ["前世连接", "今生使命", "吸引力来源", "需要学习的课题", "潜在冲突点", "灵性成长方向", "物质层面适配", "精神层面共鸣", "最终发展走向"],
    "新恋情预测": ["你的准备状态", "将遇见的类型", "出现时间提示", "发展注意事项"],
    "灵感对应牌阵": ["对方在你心里的位置", "他对你心里的位置", "我对现在关系的看法", "对方对现在关系的看法", "我对未来发展的期待", "对方对未来发展的期待"],
    "吉普赛十字牌阵": ["你的现状", "对方的心意", "当下相处模式", "外界影响", "发展结果"],
    "暗恋牌阵": ["对方是否喜欢你", "是否采取行动", "能否在一起", "对方是否喜欢的人", "建议"],
    "视奸前任牌阵": ["对方当前感情状况", "对方目前财务状况", "对方目前对你的看法", "离开之后对方有没有想起过你", "对方后悔和你分开吗"],
    "心之声牌阵": ["你们的现状", "不久的未来", "对你的内在印象", "对你的外在印象", "对方心态", "对方期待", "你的心态", "建议"],
    "未来恋人牌阵": ["对方是什么样的人", "出现了吗", "近期对方有什么暗示", "如何吸引对方", "和对方在一起有什么挑战", "在一起的收获", "你们未来发展趋势"],
    "X牌阵 复合首选": ["你们的过去", "你的现状", "对方现状", "他对复合的想法", "结果", "阻碍你的", "帮助你的", "不知道的事"],
    "二选一牌阵": ["你当下状态", "选A后的状况", "选A的结果", "选B面临的状况", "选B的结果"],
    "三角关系牌阵": ["对方现状", "你的现状", "第三方现状", "你们之间的关系", "第三方对你们的影响", "对方和第三方之间的关系"],
    "恋人金字塔牌阵": ["问卜者自己", "问卜者对象", "彼此的关系", "未来发展的走向"],
    "爱情三角牌阵": ["问卜者自己", "问卜者对象", "彼此的关系/潜力"],
    "恋人回归牌阵": ["前任对我的看法", "前任对复合的看法", "复合的阻碍", "两人关系的未来"],
    "爱情十字牌阵": ["问卜者自己的态度", "对方的态度", "现阶段状况", "未来发展", "结果"],
    "爱情关系牌阵": ["问卜者自己", "对方", "自己在这段感情中的位置", "如何一起成长", "自己渴望的成长", "建议"],
    "维纳斯之爱牌阵": ["问卜者心态", "对方心态", "对对方的真实想法", "对方对问卜者的真实想法", "阻碍", "未来自己的心态", "未来对方的心态", "想像的结果"]
}

# ----------------- 牌阵简介 (用于前端悬停显示) -----------------
SPREAD_DESCRIPTIONS = {
    "三牌时间流": "经典牌阵。快速查看事情的过去根源、现在状况和未来自然走向。",
    "爱情十字": "全方位分析。涵盖你的现状、对方真实心意、当前阻碍及最终结果。",
    "心灵感应阵": "潜意识深挖。对方在想什么？你们之间未说出口的真相是什么？",
    "复合可能性": "分手专用。分析分手根源、双方真实意愿、阻碍及复合成功率。",
    "婚姻前景阵": "备婚/长期关系。分析感情基础、现实考验与婚姻匹配度。",
    "双向视角阵": "换位思考。看清你在对方眼里的样子，以及认知差异。",
    "七日爱情阵": "运势预测。未来一周每一天的感情重点与行动建议。",
    "障碍诊断阵": "问题解决。事情卡住了？深度挖掘核心问题与深层原因。",
    "灵魂伴侣阵": "灵性分析。看你们是否是命中注定的灵魂伴侣，前世今生的连接。",
    "新恋情预测": "单身必测。下一任是新人还是旧人？特征是什么？何时出现？",
    "灵感对应牌阵": "心意互通。深度对谈双方内心真实想法与对未来的期待。",
    "吉普赛十字牌阵": "古老预测。预测短期内的运势、对方心意及外界影响。",
    "暗恋牌阵": "暧昧/暗恋。对方喜欢我吗？我该行动吗？会有结果吗？",
    "视奸前任牌阵": "窥探前任。分手后他过得好吗？有没有想你？后悔了吗？",
    "心之声牌阵": "内心共鸣。倾听彼此内心的声音，分析现状、心态与期待。",
    "未来恋人牌阵": "描绘画像。未来伴侣是什么样的人？如何吸引TA？",
    "X牌阵 复合首选": "深度复合分析。双方现状、阻碍、潜意识想法及未知因素。",
    "二选一牌阵": "决策辅助。面临两个选择（如选A人还是B人，行动还是等待）？分析各自结果。",
    "三角关系牌阵": "复杂关系。分析你、对方及第三者之间的角力与最终走向。",
    "恋人金字塔牌阵": "简洁明了。分析你们的关系结构、各自立场与未来。",
    "爱情三角牌阵": "理论分析。基于斯腾伯格爱情三元论（激情、亲密、承诺）分析潜力。",
    "恋人回归牌阵": "挽回分析。专注于前任是否会回头，以及复合的阻碍。",
    "爱情十字牌阵": "经典变体。分析双方态度、现状及最终结果。",
    "爱情关系牌阵": "共同成长。如何在关系中找到平衡？寻找双方的成长点。",
    "维纳斯之爱牌阵": "深度剖析。全方位无死角的情感分析，适合复杂情感问题。"
}

# ----------------- 路由逻辑 -----------------

@app.route('/')
def index():
    # 将描述信息传递给前端
    return render_template('index.html', spreads=SPREADS, descriptions=SPREAD_DESCRIPTIONS)

@app.route('/select')
def select():
    spread_name = request.args.get('spread')
    question = request.args.get('question')
    if not spread_name or spread_name not in SPREADS:
        return redirect(url_for('index'))

    # 生成预洗牌的牌组（包含正逆位）
    deck = [{
        'card': card,
        'orientation': random.choice(["正位", "逆位"])
    } for card in TAROT_CARDS]
    random.shuffle(deck)

    deck_info = json.dumps({
        str(i): {"card": card['card'], "orientation": card['orientation']}
        for i, card in enumerate(deck)
    }, ensure_ascii=False)

    session['deck'] = deck
    session['deck_info'] = deck_info
    session['spread_name'] = spread_name
    session['num_cards'] = len(SPREADS[spread_name])
    session['question'] = question

    return render_template('select.html',
                           num_cards=session['num_cards'],
                           spread_name=spread_name,
                           deck_info=deck_info)

@app.route('/draw', methods=['POST'])
def draw():
    try:
        selected_indices = json.loads(request.form['selected_indices'])
        spread_name = request.form['spread']
        question = session.get('question', '')

        deck = session.get('deck', [])
        spread_name_session = session.get('spread_name')
        num_cards_session = session.get('num_cards')

        if (not deck or spread_name != spread_name_session or len(selected_indices) != num_cards_session):
            return redirect(url_for('index'))

        result = []
        for idx in selected_indices:
            if 0 <= idx < len(deck):
                card_info = deck[idx]
                # 获取牌义，如果字典里没有则使用默认
                meanings = CARD_MEANINGS.get(card_info['card'], ('正位默认含义', '逆位默认含义'))
                meaning = meanings[0 if card_info['orientation'] == '正位' else 1]
                
                result.append({
                    "card": card_info['card'],
                    "orientation": card_info['orientation'],
                    "meaning": meaning
                })

        positions = SPREADS.get(spread_name, [])

        return render_template('result.html',
                               question=question,
                               cards=result,
                               positions=positions,
                               spread_name=spread_name)
    except Exception as e:
        print(f"Error: {str(e)}")
        return redirect(url_for('index'))

if __name__ == '__main__':
    app.run(debug=True, port=5002)